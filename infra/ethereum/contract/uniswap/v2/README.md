
# 原理介绍

## 恒定乘积
### 核心公式
x × y = k (常数)
其中:
x = 代币A的储备量
y = 代币B的储备量  
k = 恒定乘积常数

### 基本原理
无论如何交易，乘积k必须保持不变
交易前: x₁ × y₁ = k
交易后: x₂ × y₂ = k
因此: x₁ × y₁ = x₂ × y₂

### 公式推导
交易前: x × y = k
交易后: (x - Δx) × (y + Δy) = k

因为k不变
x × y = (x - Δx) × (y + Δy)

展开
xy = xy + xΔy - yΔx - ΔxΔy
0 = xΔy - yΔx - ΔxΔy

解出Δx/Δy
Δx = (x × Δy) / (y + Δy)
Δy = (y × Δx) / (x - Δx)

### 举例说明
以ETH/USDC池子为例
初始存入: 100 ETH + 200,000 USDC
计算k值: k = 100 × 200,000 = 20,000,000
初始价格: 1 ETH = 2,000 USDC

步骤1: 确定交易前状态
交易前储备: x₁ = 100 ETH, y₁ = 200,000 USDC
恒定乘积: k = 20,000,000

步骤2: 计算交易后储备
Bob输入: 10,000 USDC
新USDC储备: y₂ = 200,000 + 10,000 = 210,000 USDC

步骤3: 根据恒定乘积计算新ETH储备
k = x₂ × y₂
20,000,000 = x₂ × 210,000
x₂ = 20,000,000 ÷ 210,000 = 95.238 ETH

步骤4: 计算Bob获得的ETH
Bob获得: 100 - 95.238 = 4.762 ETH

## 价格机制
### 即时价格
即时价格等价储备比例，以ETH/USDC货币对为例说明：

当前ETH价格 = USDC储备量 / ETH储备量

ETH储备: 100 ETH
USDC储备: 200,000 USDC
当前ETH价格 = 200,000 / 100 = 2,000 USDC/ETH

### 边际价格
也就是交易执行价格，手续费为0.3%，以ETH/USDC货币对为例说明：

输入: 1,000 USDC
扣费后: 1,000 × 0.997 = 997 USDC

使用恒定乘积公式
获得ETH = (997 × 100) / (200,000 + 997)
        = 99,700 / 200,997
        = 0.4960 ETH

实际成交价格
实际价格 = 1,000 / 0.4960 = 2,016 USDC/ETH

交易后储备
新ETH储备: 100 - 0.4960 = 99.504 ETH
新USDC储备: 200,000 + 1,000 = 201,000 USDC

新的即时价格
新价格 = 201,000 / 99.504 = 2,020 USDC/ETH

## 激励机制
### LP代币
是一个ERC20代币，代表用户在流动性池中的份额，其作用如下：
- 权益凭证：证明用户在特定流动性池中拥有的份额
- 可交易资产：LP代币本身可以转让、交易
- 赎回凭证：用户可以用LP代币换回对应的基础资产

### 添加流动性
当首次添加流动性时，LP代币数量 = sqrt(x * y) - MINIMUM_LIQUIDITY
```
    const MINIMUM_LIQUIDITY = 1000; // 永久锁定的最小流动性
    // 使用几何平均数确保公平性
    const totalLP = Math.sqrt(amountA * amountB);
    const userLP = totalLP - MINIMUM_LIQUIDITY;
```
当后续增加流动性时，LP代币数量：
```
    // 分别按两种资产计算应得的LP数量
    const lpFromA = (newAmountA * totalSupply) / reserveA;
    const lpFromB = (newAmountB * totalSupply) / reserveB;
    
    // 取较小值，确保不会稀释现有LP持有者，
    const userLP = Math.min(lpFromA, lpFromB);
```

为什么取较小值，为了防止稀释攻击，确保攻击者不能通过添加不成比例的资产获得过多份额
添加流动性的比例不是固定的，原因：
- 防止套利攻击
- 反应真实市场价格
- 公平性保护

举例说明，Bob向现有池子添加流动性：
- 假设当前池子：100 ETH + 200,000 USDC，总LP供应：141,421
- 基于ETH：(5 * 141421) / 100 = 7071.05
- 基于USDC：(10000 * 141421) / 200000 = 7071.05
- Bob获得：7071.05 LP代币


# 常见问题

## 无常损失（Impermanent Loss）
在DeFi流动性挖矿中，由于代币价格变化导致的资产损失，也就是，你提供流动性后取出的钱，比你单纯持有代币要少。举例说明：

初始状态：
你有1个ETH（价值2000美元）+ 2000个USDC
总价值：4000美元
你把这些全部投入ETH-USDC流动性池

价格变化后：
ETH涨到3000美元
由于AMM机制，池子会自动平衡
你现在拥有：0.816个ETH + 2449个USDC
总价值：约4898美元

对比单纯持有：
如果你不做流动性挖矿，直接持有
你会有：1个ETH（3000美元）+ 2000个USDC = 5000美元

无常损失：
5000 - 4898 = 102美元的损失

当ETH价格又跌回2000美元，损失"消失"了，所以叫"无常"损失

## 滑点
交易时的预期价格与实际成交价格之间的差异。比如你想以$2000买ETH，但实际成交价是$2010，滑点就是0.5%
1. 流动性深度
2. 交易规模
3. 市场波动性
4. 网络拥堵
